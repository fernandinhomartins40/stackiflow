name: ğŸš€ Deploy Stacki to VPS

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: ğŸš€ Deploy to VPS
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: ğŸ“¦ Setup pnpm
      uses: pnpm/action-setup@v3
      with:
        version: 9.14.4
        
    - name: ğŸ“¦ Instalar dependÃªncias
      run: pnpm install
      
    - name: ğŸ—ï¸ Build aplicaÃ§Ã£o
      run: pnpm build
      env:
        NODE_ENV: production
        
    - name: ğŸ“‹ Preparar arquivos para deploy
      run: |
        tar -czf stacki-build.tar.gz \
          apps/builder/build \
          apps/builder/package.json \
          apps/builder/prisma \
          packages \
          package.json \
          pnpm-lock.yaml \
          stacki.config.js \
          docker-compose.production.yml \
          Dockerfile.production
          
    - name: ğŸš€ Deploy para VPS
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: 31.97.85.98
        username: root
        password: ${{ secrets.VPS_PASSWORD }}
        port: 22
        script: |
          echo "ğŸš€ Iniciando deploy do Stacki..."
          
          # Criar diretÃ³rio se nÃ£o existir
          mkdir -p /opt/stacki
          cd /opt/stacki
          
          # Parar serviÃ§os existentes
          echo "â¸ï¸ Parando serviÃ§os..."
          docker-compose down || true
          
          # Backup da versÃ£o anterior
          if [ -d "current" ]; then
            echo "ğŸ“¦ Fazendo backup..."
            rm -rf backup
            mv current backup
          fi
          
          # Criar novo diretÃ³rio
          mkdir -p current
          cd current
          
    - name: ğŸ“¤ Upload arquivos para VPS
      uses: appleboy/scp-action@v0.1.7
      with:
        host: 31.97.85.98
        username: root
        password: ${{ secrets.VPS_PASSWORD }}
        port: 22
        source: "stacki-build.tar.gz"
        target: "/opt/stacki/current/"
        
    - name: ğŸ”§ Configurar e iniciar aplicaÃ§Ã£o
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: 31.97.85.98
        username: root
        password: ${{ secrets.VPS_PASSWORD }}
        port: 22
        script: |
          cd /opt/stacki/current
          
          echo "ğŸ“¦ Extraindo arquivos..."
          tar -xzf stacki-build.tar.gz
          rm stacki-build.tar.gz
          
          echo "ğŸ”§ Configurando ambiente..."
          # Copiar .env de produÃ§Ã£o se existir
          if [ -f "/opt/stacki/.env.production" ]; then
            cp /opt/stacki/.env.production apps/builder/.env
          fi
          
          echo "ğŸ³ Iniciando com Docker..."
          docker-compose -f docker-compose.production.yml up -d
          
          echo "â±ï¸ Aguardando aplicaÃ§Ã£o iniciar..."
          sleep 30
          
          echo "ğŸ” Verificando status..."
          docker-compose -f docker-compose.production.yml ps
          
          echo "âœ… Deploy concluÃ­do!"
          echo "ğŸŒ Stacki disponÃ­vel em: https://www.stacki.com.br"
          echo "ğŸ”§ Para configurar SSL na primeira vez, execute:"
          echo "cd /opt/stacki && ./setup-ssl.sh"
          
    - name: âœ… Notificar sucesso
      if: success()
      run: |
        echo "ğŸ‰ Deploy realizado com sucesso!"
        echo "ğŸŒ AplicaÃ§Ã£o disponÃ­vel em: https://www.stacki.com.br"
        
    - name: âŒ Notificar falha
      if: failure()
      run: |
        echo "ğŸ’¥ Deploy falhou!"
        echo "Verifique os logs para mais detalhes."