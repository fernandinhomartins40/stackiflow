name: ğŸš€ Deploy Stacki to VPS

on:
  push:
    branches: [ main ]

# Prevent concurrent deployments
concurrency:
  group: deploy-stacki-vps
  cancel-in-progress: true

jobs:
  deploy:
    name: ğŸš€ Deploy to VPS
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: ğŸ“¦ Setup pnpm
      uses: pnpm/action-setup@v3
      with:
        version: 9.14.4
        
    - name: ğŸ“¦ Instalar dependÃªncias
      run: pnpm install
      
    - name: ğŸ—ï¸ Build aplicaÃ§Ã£o
      run: pnpm build
      env:
        NODE_ENV: production
        
    - name: ğŸ“‹ Preparar arquivos para deploy
      run: |
        # Create deployment package with only existing files
        tar -czf stacki-build.tar.gz \
          --exclude='node_modules' \
          --exclude='.git' \
          --exclude='*.test.*' \
          --exclude='*.stories.*' \
          apps/builder/build \
          apps/builder/package.json \
          packages/prisma-client \
          packages/css-data \
          packages/css-engine \
          packages/design-system \
          packages/react-sdk \
          packages/sdk \
          packages/sdk-components-react \
          packages/fonts \
          packages/icons \
          packages/image \
          package.json \
          pnpm-lock.yaml \
          stacki.config.js \
          docker-compose.production.yml \
          Dockerfile.production
          
    - name: ğŸ” Debug conectividade VPS
      run: |
        echo "ğŸ” Testando conectividade com VPS..."
        ping -c 3 31.97.85.98 || echo "âš ï¸ Ping falhou"
        nc -z -v 31.97.85.98 22 || echo "âš ï¸ SSH port inacessÃ­vel"
        curl -I --connect-timeout 10 http://31.97.85.98 || echo "âš ï¸ HTTP inacessÃ­vel"
        
    - name: ğŸš€ Deploy para VPS
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: 31.97.85.98
        username: root
        password: ${{ secrets.VPS_PASSWORD }}
        port: 22
        timeout: 300s
        command_timeout: 600s
        script: |
          echo "ğŸš€ Iniciando deploy do Stacki..."
          
          # Criar diretÃ³rio se nÃ£o existir
          mkdir -p /opt/stacki
          cd /opt/stacki
          
          # Verificar conflitos de porta
          echo "ğŸ” Verificando conflitos de porta..."
          netstat -tlnp | grep -E ":(3008|3009|5434)" && echo "AVISO: Algumas portas podem estar ocupadas" || echo "Portas disponÃ­veis"
          
          # Verificar conflitos de banco de dados
          echo "ğŸ—„ï¸ Verificando conflitos de banco de dados..."
          docker ps --filter "ancestor=postgres" --format "table {{.Names}}\t{{.Ports}}" | grep -v "PORTS" || echo "Nenhum PostgreSQL conflitante"
          
          # Parar serviÃ§os existentes
          echo "â¸ï¸ Parando serviÃ§os..."
          docker-compose down || true
          
          # Parar serviÃ§os conflitantes nas novas portas
          echo "ğŸ›‘ Parando serviÃ§os conflitantes..."
          docker stop $(docker ps -q --filter "publish=3008" --filter "publish=3009" --filter "publish=5434") 2>/dev/null || true
          
          # Limpar redes conflitantes
          echo "ğŸŒ‰ Limpando redes conflitantes..."
          docker network rm stacki_network_isolated 2>/dev/null || true
          
          # Backup da versÃ£o anterior
          if [ -d "current" ]; then
            echo "ğŸ“¦ Fazendo backup..."
            rm -rf backup
            mv current backup
          fi
          
          # Criar novo diretÃ³rio
          mkdir -p current
          cd current
          
    - name: ğŸ“¤ Upload arquivos para VPS
      uses: appleboy/scp-action@v0.1.7
      with:
        host: 31.97.85.98
        username: root
        password: ${{ secrets.VPS_PASSWORD }}
        port: 22
        timeout: 300s
        command_timeout: 600s
        source: "stacki-build.tar.gz"
        target: "/opt/stacki/current/"
        overwrite: true
        
    - name: ğŸ”§ Configurar e iniciar aplicaÃ§Ã£o
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: 31.97.85.98
        username: root
        password: ${{ secrets.VPS_PASSWORD }}
        port: 22
        script: |
          cd /opt/stacki/current
          
          echo "ğŸ“¦ Extraindo arquivos..."
          tar -xzf stacki-build.tar.gz
          rm stacki-build.tar.gz
          
          echo "ğŸ”§ Configurando ambiente..."
          # Copiar .env de produÃ§Ã£o se existir
          if [ -f "/opt/stacki/.env.production" ]; then
            cp /opt/stacki/.env.production apps/builder/.env
          fi
          
          echo "ğŸ³ Iniciando com Docker..."
          docker-compose -f docker-compose.production.yml up -d
          
          echo "â±ï¸ Aguardando aplicaÃ§Ã£o iniciar..."
          sleep 30
          
          echo "ğŸ” Verificando status..."
          docker-compose -f docker-compose.production.yml ps
          
          echo "âœ… Deploy concluÃ­do!"
          echo "ğŸŒ Stacki disponÃ­vel em: https://www.stacki.com.br"
          echo "ğŸ”§ Para configurar SSL na primeira vez, execute:"
          echo "cd /opt/stacki && ./setup-ssl.sh"
          
    - name: âœ… Notificar sucesso
      if: success()
      run: |
        echo "ğŸ‰ Deploy realizado com sucesso!"
        echo "ğŸŒ AplicaÃ§Ã£o disponÃ­vel em: https://www.stacki.com.br"
        
    - name: âŒ Notificar falha
      if: failure()
      run: |
        echo "ğŸ’¥ Deploy falhou!"
        echo "Verifique os logs para mais detalhes."